<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Anesthesia Jeopardy (Self-Contained)</title>
  <style>
    :root{
      --bg:#06122b;
      --panel:#0b1c43;
      --panel2:#0e265c;
      --text:#f3f6ff;
      --muted:#b9c6ff;
      --accent:#ffd34d;
      --danger:#ff5b6b;
      --ok:#45f39a;
      --tile:#0b2a74;
      --tileUsed:#13203b;
      --border:rgba(255,255,255,.12);
      --shadow: 0 10px 30px rgba(0,0,0,.35);
      --radius:14px;
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      --sans: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji";
    }
    *{ box-sizing:border-box; }
    body{
      margin:0;
      font-family:var(--sans);
      background: radial-gradient(1200px 900px at 20% 10%, #12307a 0%, var(--bg) 55%, #040a18 100%);
      color:var(--text);
      min-height:100vh;
    }
    header{
      padding:16px 14px 10px;
      display:flex;
      gap:12px;
      align-items:flex-start;
      justify-content:space-between;
      flex-wrap:wrap;
    }
    .brand{
      display:flex;
      gap:12px;
      align-items:center;
      flex-wrap:wrap;
    }
    .logo{
      width:44px;height:44px;border-radius:12px;
      background: linear-gradient(145deg, #1a45b8, #0b1c43);
      display:grid;place-items:center;
      box-shadow: var(--shadow);
      border:1px solid var(--border);
      font-weight:900;
      color:var(--accent);
      letter-spacing:.5px;
    }
    h1{
      margin:0;
      font-size:18px;
      line-height:1.15;
    }
    .sub{
      color:var(--muted);
      font-size:12px;
      margin-top:2px;
    }
    .controls{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      align-items:center;
      justify-content:flex-end;
    }
    button, .btn{
      appearance:none;
      border:1px solid var(--border);
      background: rgba(255,255,255,.06);
      color:var(--text);
      padding:10px 12px;
      border-radius:12px;
      font-weight:700;
      cursor:pointer;
      box-shadow: 0 4px 14px rgba(0,0,0,.18);
      transition: transform .05s ease, background .2s ease, border-color .2s ease;
      user-select:none;
      font-size:13px;
    }
    button:hover{ background: rgba(255,255,255,.1); border-color: rgba(255,255,255,.2); }
    button:active{ transform: translateY(1px); }
    button.primary{
      background: linear-gradient(180deg, rgba(255,211,77,.24), rgba(255,211,77,.10));
      border-color: rgba(255,211,77,.35);
      color: #fff6d4;
    }
    button.danger{
      background: linear-gradient(180deg, rgba(255,91,107,.22), rgba(255,91,107,.10));
      border-color: rgba(255,91,107,.35);
    }
    button.ok{
      background: linear-gradient(180deg, rgba(69,243,154,.20), rgba(69,243,154,.08));
      border-color: rgba(69,243,154,.35);
    }
    button:disabled{
      opacity:.55;
      cursor:not-allowed;
      transform:none !important;
    }

    main{
      padding:0 14px 16px;
      display:grid;
      gap:14px;
      grid-template-columns: 1fr;
      max-width: 1200px;
      margin:0 auto;
    }

    /* Top strip: teams + timer */
    .topStrip{
      display:grid;
      gap:12px;
      grid-template-columns: 1fr;
      align-items:stretch;
    }
    @media (min-width: 900px){
      .topStrip{ grid-template-columns: 1.5fr 1fr; }
    }

    .card{
      background: rgba(255,255,255,.05);
      border:1px solid var(--border);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .cardHeader{
      padding:12px 12px 10px;
      border-bottom:1px solid var(--border);
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:10px;
      background: linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.02));
    }
    .cardHeader .title{
      font-weight:900;
      letter-spacing:.2px;
      font-size:13px;
      color:#eaf0ff;
    }
    .cardBody{ padding:12px; }

    .teams{
      display:grid;
      gap:10px;
      grid-template-columns: repeat(1, minmax(0,1fr));
    }
    @media (min-width: 620px){
      .teams{ grid-template-columns: repeat(3, minmax(0,1fr)); }
    }

    .team{
      background: rgba(11,28,67,.45);
      border:1px solid var(--border);
      border-radius: 14px;
      padding:10px;
      display:grid;
      gap:8px;
      position:relative;
    }
    .team.active{
      outline: 2px solid rgba(255,211,77,.65);
      box-shadow: 0 0 0 6px rgba(255,211,77,.12);
    }
    .teamRow{
      display:flex; gap:8px; align-items:center; justify-content:space-between;
    }
    .teamName{
      display:flex; gap:8px; align-items:center; min-width:0;
    }
    .badge{
      font-family:var(--mono);
      font-weight:900;
      font-size:12px;
      color:var(--accent);
      background: rgba(255,211,77,.12);
      border:1px solid rgba(255,211,77,.25);
      padding:3px 7px;
      border-radius:999px;
      flex:0 0 auto;
    }
    .nameInput{
      width:100%;
      padding:8px 10px;
      border-radius:10px;
      border:1px solid var(--border);
      background: rgba(255,255,255,.06);
      color:var(--text);
      font-weight:800;
      min-width:0;
    }
    .score{
      font-family:var(--mono);
      font-weight:900;
      font-size:18px;
      color:#ffffff;
      letter-spacing:.2px;
    }
    .teamActions{
      display:flex; gap:8px; flex-wrap:wrap;
    }
    .tiny{
      padding:8px 10px;
      font-size:12px;
      border-radius:10px;
    }

    .timerBox{
      display:grid;
      gap:10px;
    }
    .timerRow{
      display:flex;
      flex-wrap:wrap;
      gap:10px;
      align-items:center;
      justify-content:space-between;
    }
    .toggle{
      display:flex; align-items:center; gap:10px;
      color:var(--muted);
      font-weight:700;
      font-size:13px;
    }
    .toggle input{ transform: scale(1.1); }
    .rangeWrap{
      display:flex; gap:10px; align-items:center; flex-wrap:wrap;
      color:var(--muted);
      font-weight:700;
      font-size:13px;
    }
    input[type="range"]{ width:180px; }
    .countdown{
      font-family:var(--mono);
      font-size:28px;
      font-weight:1000;
      letter-spacing:1px;
      padding:8px 12px;
      border-radius:12px;
      background: rgba(0,0,0,.18);
      border:1px solid var(--border);
      min-width: 110px;
      text-align:center;
    }
    .countdown.warn{
      color: var(--accent);
      border-color: rgba(255,211,77,.35);
      background: rgba(255,211,77,.08);
    }
    .countdown.danger{
      color: var(--danger);
      border-color: rgba(255,91,107,.40);
      background: rgba(255,91,107,.08);
    }

    /* Board */
    .board{
      background: rgba(255,255,255,.04);
      border:1px solid var(--border);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .grid{
      display:grid;
      grid-template-columns: repeat(6, 1fr);
      gap: 0;
    }
    .cat{
      background: linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.02));
      border-right:1px solid var(--border);
      border-bottom:1px solid var(--border);
      padding:10px 8px;
      text-align:center;
      font-weight:1000;
      font-size:12px;
      letter-spacing:.6px;
      text-transform:uppercase;
    }
    .cat:last-child{ border-right:none; }

    .tile{
      background: linear-gradient(180deg, rgba(18,48,122,.75), rgba(11,28,67,.85));
      border-right:1px solid rgba(255,255,255,.10);
      border-bottom:1px solid rgba(255,255,255,.10);
      height: 84px;
      display:grid;
      place-items:center;
      cursor:pointer;
      position:relative;
      user-select:none;
      transition: transform .05s ease, filter .2s ease, background .2s ease;
    }
    .tile:hover{ filter: brightness(1.06); }
    .tile:active{ transform: translateY(1px); }
    .tile.used{
      background: linear-gradient(180deg, rgba(19,32,59,.85), rgba(9,15,28,.90));
      cursor:not-allowed;
      filter:saturate(.7) brightness(.85);
    }
    .money{
      font-family:var(--mono);
      font-weight:1000;
      font-size:24px;
      color: var(--accent);
      text-shadow: 0 2px 0 rgba(0,0,0,.35);
    }
    .tile.used .money{ opacity:.18; }
    .ddPip{
      position:absolute;
      top:10px; right:10px;
      width:10px; height:10px;
      border-radius:999px;
      background: rgba(255,211,77,.9);
      box-shadow: 0 0 0 4px rgba(255,211,77,.18);
      display:none;
    }
    .tile.dd:not(.used) .ddPip{ display:block; }

    @media (max-width: 520px){
      .tile{ height: 70px; }
      .money{ font-size:20px; }
      .cat{ font-size:10px; padding:8px 6px; }
    }

    /* Modal */
    .modalBackdrop{
      position:fixed; inset:0;
      background: rgba(0,0,0,.55);
      display:none;
      align-items:center;
      justify-content:center;
      padding:14px;
      z-index:999;
    }
    .modalBackdrop.show{ display:flex; }
    .modal{
      width:min(860px, 100%);
      max-height: min(85vh, 900px);
      overflow:auto;
      background: linear-gradient(180deg, rgba(12,26,60,.96), rgba(7,14,31,.96));
      border:1px solid rgba(255,255,255,.14);
      border-radius: 18px;
      box-shadow: 0 20px 60px rgba(0,0,0,.6);
    }
    .modalHeader{
      padding:14px 14px 12px;
      border-bottom:1px solid rgba(255,255,255,.12);
      display:flex;
      gap:10px;
      align-items:flex-start;
      justify-content:space-between;
    }
    .modalTitle{
      display:grid;
      gap:2px;
      min-width:0;
    }
    .modalTitle .small{
      color: var(--muted);
      font-size:12px;
      font-weight:800;
      letter-spacing:.2px;
      display:flex;
      gap:8px;
      flex-wrap:wrap;
      align-items:center;
    }
    .pill{
      font-family:var(--mono);
      font-weight:900;
      font-size:12px;
      padding:3px 8px;
      border-radius:999px;
      border:1px solid var(--border);
      background: rgba(255,255,255,.06);
      color:#eaf0ff;
    }
    .pill.dd{
      border-color: rgba(255,211,77,.4);
      background: rgba(255,211,77,.10);
      color:#fff0bf;
    }
    .modalTitle h2{
      margin:0;
      font-size:16px;
      line-height:1.25;
      font-weight:1000;
      word-break:break-word;
    }
    .modalBody{
      padding:14px;
      display:grid;
      gap:12px;
    }
    .clueBox{
      background: rgba(255,255,255,.05);
      border:1px solid rgba(255,255,255,.12);
      border-radius: 16px;
      padding:14px;
      display:grid;
      gap:10px;
    }
    .clueText{
      font-size:18px;
      line-height:1.35;
      font-weight:900;
      letter-spacing:.1px;
    }
    .answer{
      display:none;
      padding-top:10px;
      border-top:1px dashed rgba(255,255,255,.18);
      color:#e9f6ff;
      font-size:16px;
      line-height:1.35;
      font-weight:850;
    }
    .answer.show{ display:block; }
    .wagerBox{
      display:none;
      background: rgba(255,211,77,.08);
      border:1px solid rgba(255,211,77,.25);
      border-radius: 16px;
      padding:12px;
      gap:10px;
    }
    .wagerBox.show{ display:grid; }
    .wagerRow{
      display:flex;
      gap:10px;
      align-items:center;
      flex-wrap:wrap;
      justify-content:space-between;
    }
    .wagerRow label{
      font-weight:900;
      color:#fff3c8;
    }
    .wagerInput{
      width: 160px;
      padding:10px 10px;
      border-radius:12px;
      border:1px solid rgba(255,211,77,.35);
      background: rgba(0,0,0,.20);
      color: var(--text);
      font-family: var(--mono);
      font-weight:1000;
      font-size:14px;
    }
    .hint{
      color: var(--muted);
      font-size:12px;
      font-weight:700;
      line-height:1.25;
    }
    .modalFooter{
      padding:12px 14px 14px;
      border-top:1px solid rgba(255,255,255,.12);
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      justify-content:flex-end;
    }
    .row{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      align-items:center;
      justify-content:space-between;
    }
    .statusLine{
      color: var(--muted);
      font-weight:800;
      font-size:12px;
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      align-items:center;
    }

    /* Final Jeopardy panel */
    .finalPanel{
      display:grid;
      gap:10px;
    }
    .finalPanel .finalClue{
      font-size:18px;
      font-weight:950;
      line-height:1.35;
      color:#ffffff;
    }
    .finalGrid{
      display:grid;
      gap:10px;
      grid-template-columns: 1fr;
    }
    @media (min-width:720px){
      .finalGrid{ grid-template-columns: 1fr 1fr; }
    }
    .finalTeamBox{
      border:1px solid rgba(255,255,255,.12);
      border-radius: 16px;
      padding:12px;
      background: rgba(255,255,255,.05);
      display:grid;
      gap:8px;
    }
    .finalTeamTop{
      display:flex;
      justify-content:space-between;
      gap:10px;
      align-items:center;
      flex-wrap:wrap;
    }
    .finalTeamTop .nm{ font-weight:1000; }
    .finalTeamTop .sc{ font-family:var(--mono); font-weight:1000; color:var(--muted); }
    .finalInputs{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      align-items:center;
      justify-content:space-between;
    }
    .finalInputs input[type="text"]{
      flex:1 1 260px;
      padding:10px 10px;
      border-radius:12px;
      border:1px solid rgba(255,255,255,.14);
      background: rgba(0,0,0,.20);
      color: var(--text);
      font-weight:850;
    }
    .finalInputs input[type="number"]{
      width: 140px;
      padding:10px 10px;
      border-radius:12px;
      border:1px solid rgba(255,211,77,.35);
      background: rgba(0,0,0,.20);
      color: var(--text);
      font-family: var(--mono);
      font-weight:1000;
    }

    /* File inputs hidden */
    input[type="file"]{ display:none; }

    /* Footer note */
    .footNote{
      color: rgba(185,198,255,.85);
      font-size:11px;
      line-height:1.35;
      padding:0 14px 18px;
      max-width:1200px;
      margin:0 auto;
    }
    a{ color: #a9c2ff; }
  </style>
</head>
<body>
  <header>
    <div class="brand">
      <div class="logo">A</div>
      <div>
        <h1>Anesthesia Jeopardy</h1>
        <div class="sub">Single-file (HTML/CSS/JS) • Local save • Editable clues • 1–3 teams</div>
      </div>
    </div>

    <div class="controls">
      <button id="finalBtn" class="primary" title="Play Final Jeopardy (after the board, or anytime)">Final Jeopardy</button>
      <button id="exportBtn" title="Download the clue set as JSON">Export clues to JSON</button>
      <button id="importBtn" title="Import a clue set JSON file">Import clues from JSON</button>
      <input id="importFile" type="file" accept="application/json" />
      <button id="resetBtn" class="danger" title="Reset scores + used clues + daily doubles">Reset Game</button>
    </div>
  </header>

  <main>
    <section class="topStrip">
      <div class="card">
        <div class="cardHeader">
          <div class="title">Teams & Turn</div>
          <div class="statusLine">
            <span class="pill" id="turnPill">Turn: Team 1</span>
            <span class="pill" id="cluesLeftPill">Clues left: 30</span>
          </div>
        </div>
        <div class="cardBody">
          <div class="teams" id="teamsWrap"></div>
          <div style="margin-top:10px; display:flex; gap:10px; flex-wrap:wrap; align-items:center; justify-content:space-between;">
            <div class="hint">
              Tip: Edit team names, then use <b>Next Turn</b> to rotate (or it auto-advances after each clue if you want).
            </div>
            <div style="display:flex; gap:10px; flex-wrap:wrap;">
              <button id="prevTurnBtn" class="tiny">◀ Prev Turn</button>
              <button id="nextTurnBtn" class="tiny primary">Next Turn ▶</button>
              <button id="autoTurnBtn" class="tiny" title="If on, turn advances after Correct/Incorrect">Auto-advance: <span id="autoTurnState">ON</span></button>
            </div>
          </div>
        </div>
      </div>

      <div class="card">
        <div class="cardHeader">
          <div class="title">Optional Timer</div>
          <div class="statusLine">
            <span class="pill" id="timerPill">Timer: OFF</span>
          </div>
        </div>
        <div class="cardBody timerBox">
          <div class="timerRow">
            <div class="toggle">
              <input id="timerEnabled" type="checkbox" />
              <label for="timerEnabled">Enable timer</label>
            </div>
            <div class="rangeWrap">
              <span>Seconds:</span>
              <input id="timerSeconds" type="range" min="30" max="60" step="5" value="45" />
              <span class="pill" id="timerSecondsLabel">45</span>
            </div>
          </div>

          <div class="timerRow">
            <div class="countdown" id="countdown">00:45</div>
            <div style="display:flex; gap:10px; flex-wrap:wrap; justify-content:flex-end;">
              <button id="timerStart" class="ok">Start</button>
              <button id="timerStop">Stop</button>
              <button id="timerReset">Reset</button>
              <button id="buzzBtn" class="danger" title="Manual buzzer">Buzz</button>
            </div>
          </div>

          <div class="hint">
            The buzzer uses the Web Audio API (no external files). Timer starts automatically when a clue opens (if enabled).
          </div>
        </div>
      </div>
    </section>

    <section class="board">
      <div class="grid" id="boardGrid"></div>
    </section>
  </main>

  <div class="footNote">
    Educational review game only. Use local protocols and current guidelines for patient care decisions.
    Clues are original (no verbatim textbook text) and inspired by standard anesthesia concepts.
  </div>

  <!-- CLUE MODAL -->
  <div class="modalBackdrop" id="modalBackdrop" role="dialog" aria-modal="true" aria-hidden="true">
    <div class="modal">
      <div class="modalHeader">
        <div class="modalTitle">
          <div class="small">
            <span class="pill" id="modalCat">Category</span>
            <span class="pill" id="modalVal">$0</span>
            <span class="pill dd" id="modalDD" style="display:none;">DAILY DOUBLE</span>
          </div>
          <h2 id="modalHeading">Clue</h2>
        </div>
        <button id="modalCloseTop" title="Close (Esc)">✕</button>
      </div>

      <div class="modalBody">
        <div class="clueBox">
          <div class="clueText" id="clueText"></div>

          <div class="wagerBox" id="wagerBox">
            <div class="wagerRow">
              <label for="wagerInput">Daily Double wager (Team on turn):</label>
              <input class="wagerInput" id="wagerInput" type="number" min="0" step="50" />
            </div>
            <div class="hint" id="wagerHint"></div>
          </div>

          <div class="answer" id="answerText"></div>
        </div>

        <div class="row">
          <div class="statusLine" id="modalStatus"></div>
          <div class="statusLine" style="justify-content:flex-end;">
            <span class="pill" id="answerStatePill">Answer: hidden</span>
          </div>
        </div>
      </div>

      <div class="modalFooter">
        <button id="showAnswerBtn" class="primary">Show Answer</button>
        <button id="correctBtn" class="ok" disabled>Correct (+$)</button>
        <button id="incorrectBtn" class="danger" disabled>Incorrect (-$)</button>
        <button id="closeBtn">Close</button>
      </div>
    </div>
  </div>

  <!-- FINAL JEOPARDY MODAL -->
  <div class="modalBackdrop" id="finalBackdrop" role="dialog" aria-modal="true" aria-hidden="true">
    <div class="modal">
      <div class="modalHeader">
        <div class="modalTitle">
          <div class="small">
            <span class="pill">Final Jeopardy</span>
            <span class="pill" id="finalCatPill">Category</span>
          </div>
          <h2 id="finalHeading">Final Jeopardy</h2>
        </div>
        <button id="finalCloseTop" title="Close (Esc)">✕</button>
      </div>

      <div class="modalBody">
        <div class="clueBox finalPanel">
          <div class="finalClue" id="finalClueText"></div>
          <div class="hint" id="finalHint"></div>

          <div class="finalGrid" id="finalGrid"></div>

          <div class="answer" id="finalAnswerText"></div>
        </div>

        <div class="row">
          <div class="statusLine" id="finalStatus"></div>
          <div class="statusLine" style="justify-content:flex-end;">
            <span class="pill" id="finalAnswerState">Answer: hidden</span>
          </div>
        </div>
      </div>

      <div class="modalFooter">
        <button id="finalShowAnswerBtn" class="primary">Show Answer</button>
        <button id="finalApplyBtn" class="ok" disabled>Apply Results</button>
        <button id="finalCloseBtn">Close</button>
      </div>
    </div>
  </div>

  <script>
    /******************************************************************
     *  EDIT CLUES HERE (one obvious JS object)
     *  - No external libraries/assets.
     *  - Each clue has: value, clue, answer, sourceTag (hidden in UI).
     ******************************************************************/
    const DEFAULT_CLUESET = {
      version: 1,
      categories: [
        {
          name: "Airway",
          clues: [
            {
              value: 200,
              clue: "In a patient with suspected laryngospasm after extubation, your FIRST two maneuvers are to remove the stimulus, apply jaw thrust, and deliver what specific type of mask ventilation?",
              answer: "Continuous positive pressure (tight mask seal) with 100% O₂ while performing jaw thrust (Larson’s maneuver can be added).",
              sourceTag: "Barash 9e — Airway — Laryngospasm initial management"
            },
            {
              value: 400,
              clue: "During preoxygenation, which bedside sign most directly tells you you’ve likely maximized denitrogenation: time, end-tidal O₂, or SpO₂? Pick the best and why.",
              answer: "End-tidal O₂ (EtO₂). SpO₂ can stay 100% even with poor denitrogenation; EtO₂ rising (often targeted ≥ ~90%) reflects alveolar wash-in of O₂.",
              sourceTag: "Miller Basics 8e — Airway — Preoxygenation / EtO₂"
            },
            {
              value: 600,
              clue: "You place a standard LMA, ventilation is difficult, and you hear a leak. Name TWO common correctable causes related to positioning/size before you abandon the device.",
              answer: "Malposition (too shallow/deep), inadequate cuff inflation/overinflation causing fold/poor seal, wrong size for patient, head/neck not in neutral/sniffing, bite/obstruction.",
              sourceTag: "Barash 9e — Airway — Supraglottic airway troubleshooting"
            },
            {
              value: 800,
              clue: "A patient has a known difficult airway and will need awake intubation. Give a pragmatic topicalization plan: the key anatomic targets to anesthetize (not drug brand names).",
              answer: "Topicalize nasal/oral mucosa, oropharynx (glossopharyngeal territory), larynx/supraglottis (superior laryngeal territory), and trachea (recurrent laryngeal) via transtracheal/laryngeal spray; add antisialagogue + gentle sedation as needed.",
              sourceTag: "Barash 9e — Airway — Awake intubation topical anesthesia"
            },
            {
              value: 1000,
              clue: "You suspect ‘can’t intubate, can’t oxygenate’ is imminent. What’s the single most important EARLY decision point that improves outcomes: adding more attempts, changing operator, or changing the plan? Be specific.",
              answer: "Change the plan early—limit attempts and move promptly to an oxygenation-focused rescue pathway (e.g., SGA, then front-of-neck access) rather than repeated laryngoscopy attempts.",
              sourceTag: "Miller Basics 8e — Airway — Failed airway / CICO principles"
            }
          ]
        },
        {
          name: "Critical Care",
          clues: [
            {
              value: 200,
              clue: "In undifferentiated shock, what bedside echo finding most strongly suggests obstructive shock from tamponade rather than distributive shock?",
              answer: "Pericardial effusion with diastolic collapse of right-sided chambers (RA/RV) and a plethoric IVC with limited respiratory variation.",
              sourceTag: "Barash 9e — Critical Care — Shock ultrasound / tamponade physiology"
            },
            {
              value: 400,
              clue: "On volume-controlled ventilation, what does an increased peak pressure with an unchanged plateau pressure suggest: decreased compliance or increased airway resistance?",
              answer: "Increased airway resistance (e.g., bronchospasm, kinked tube, secretions). Compliance problems raise BOTH peak and plateau.",
              sourceTag: "Miller Basics 8e — Critical Care — Ventilator waveforms/pressures"
            },
            {
              value: 600,
              clue: "Name the FOUR classic causes of a high anion-gap metabolic acidosis you’d want at your fingertips in the ICU (no mnemonics required—just the big etiologies).",
              answer: "Lactic acidosis, ketoacidosis, renal failure/uremia, and toxic ingestions (e.g., salicylates, ethylene glycol, methanol).",
              sourceTag: "Miller Basics 8e — Critical Care — Acid–base, anion gap"
            },
            {
              value: 800,
              clue: "You’re troubleshooting sudden hypotension after intubation in a septic patient. Give two ventilation-related mechanisms and the immediate bedside fixes.",
              answer: "Decreased venous return from high intrathoracic pressure/auto-PEEP → reduce tidal volume/PEEP, disconnect briefly to exhale; and dynamic hyperinflation → allow longer expiratory time, treat bronchospasm/obstruction, reassess volume/pressor needs.",
              sourceTag: "Barash 9e — Critical Care — Post-intubation hypotension / auto-PEEP"
            },
            {
              value: 1000,
              clue: "A ventilated ARDS patient desaturates with rising plateau pressures. Your team debates increasing tidal volume versus accepting hypercapnia. What’s the lung-protective priority and why?",
              answer: "Prioritize limiting overdistension (lower VT strategy) to reduce ventilator-induced lung injury; permissive hypercapnia may be acceptable if pH is tolerable and there are no contraindications, while monitoring hemodynamics/ICP/arrhythmias.",
              sourceTag: "Barash 9e — Critical Care — ARDS lung-protective ventilation rationale"
            }
          ]
        },
        {
          name: "OB",
          clues: [
            {
              value: 200,
              clue: "In late pregnancy, which airway/GI change most directly increases the urgency of aspiration risk mitigation during induction?",
              answer: "Reduced lower esophageal sphincter tone and increased intra-abdominal pressure (plus delayed gastric emptying in labor/opioids), increasing aspiration risk.",
              sourceTag: "Miller Basics 8e — OB — Aspiration risk / physiologic changes"
            },
            {
              value: 400,
              clue: "A laboring patient becomes hypotensive immediately after a neuraxial bolus. Name the primary mechanism and the first-line non-drug maneuver.",
              answer: "Sympathetic blockade causing decreased SVR/venous return; left uterine displacement (manual displacement or wedge) to relieve aortocaval compression.",
              sourceTag: "Barash 9e — OB — Neuraxial hypotension / aortocaval compression"
            },
            {
              value: 600,
              clue: "After delivery, uterine atony persists. You’re asked which uterotonic is most concerning in a patient with severe asthma. Which is it and what’s the concern?",
              answer: "Carboprost (15-methyl PGF2α) due to risk of bronchospasm.",
              sourceTag: "Barash 9e — OB — Uterotonics contraindications"
            },
            {
              value: 800,
              clue: "You’re converting a functioning labor epidural to surgical anesthesia for urgent cesarean. What clinical test best confirms adequate block height for incision: pinprick, cold, or motor strength—and what level are you aiming for?",
              answer: "Cold (and/or pinprick) sensory level assessment; aim for approximately T4 level for cesarean incision/traction (with attention to patient symptoms and comfort).",
              sourceTag: "Miller Basics 8e — OB — Cesarean neuraxial level assessment"
            },
            {
              value: 1000,
              clue: "In suspected local anesthetic systemic toxicity (LAST) after neuraxial dosing, what resuscitation-specific therapy should be initiated early, and what’s the standard initial bolus for 20% lipid emulsion?",
              answer: "Initiate lipid emulsion therapy early; 20% lipid bolus 1.5 mL/kg (then infusion commonly 0.25 mL/kg/min, with dose limits per protocol).",
              sourceTag: "Miller Basics 8e — Regional/OB — LAST and lipid therapy"
            }
          ]
        },
        {
          name: "Cardiothoracic",
          clues: [
            {
              value: 200,
              clue: "In severe aortic stenosis, which hemodynamic variable is most dangerous to lose abruptly: preload, afterload, or heart rate? Choose the best and explain briefly.",
              answer: "Afterload (systemic pressure) — sudden drops in SVR/coronary perfusion pressure can precipitate ischemia and collapse; also avoid tachycardia and maintain preload, but hypotension is especially poorly tolerated.",
              sourceTag: "Barash 9e — Cardiothoracic — Aortic stenosis anesthetic goals"
            },
            {
              value: 400,
              clue: "A fresh cardiac surgery patient is paced VVI at 80 but becomes hypotensive when the rate is decreased. What physiologic principle explains the benefit of pacing in a stiff ventricle?",
              answer: "With diastolic dysfunction, stroke volume is relatively fixed; cardiac output becomes more rate-dependent (CO = SV × HR), so higher HR may support CO.",
              sourceTag: "Miller Basics 8e — Cardiothoracic — Diastolic dysfunction / rate dependence"
            },
            {
              value: 600,
              clue: "During one-lung ventilation, SpO₂ falls. Name the MOST effective initial ventilator adjustment to the dependent lung before adding CPAP to the nondependent lung.",
              answer: "Increase FiO₂ to 1.0 and optimize ventilation of the dependent lung (check tube position, apply appropriate PEEP, ensure adequate tidal volume/pressure limits).",
              sourceTag: "Barash 9e — Thoracic — OLV hypoxemia troubleshooting"
            },
            {
              value: 800,
              clue: "On TEE, you see a new, severe mitral regurgitation jet immediately after coming off bypass. Name TWO urgent categories of causes you must consider intraoperatively.",
              answer: "Surgical/structural issues (annuloplasty ring problem, leaflet injury, chordal/papillary muscle dysfunction) and ischemia (especially inferior/posterior wall) causing papillary muscle dysfunction; also consider LV distension/loading changes.",
              sourceTag: "Barash 9e — Cardiothoracic — Post-CPB MR differential"
            },
            {
              value: 1000,
              clue: "You suspect right ventricular failure after LVAD placement/TEE shows a dilated RV with poor function. Give a management triad: preload, afterload (PVR), and contractility/rhythm.",
              answer: "Optimize preload (avoid both underfilling and overdistension), reduce PVR (oxygenation, avoid hypercarbia/acidosis, consider pulmonary vasodilators), and support contractility/rhythm (inotrope, maintain sinus/AV synchrony, consider pacing).",
              sourceTag: "Miller Basics 8e — Cardiothoracic — RV failure physiology and management"
            }
          ]
        },
        {
          name: "Anesthesia Workstation",
          clues: [
            {
              value: 200,
              clue: "Your capnogram abruptly becomes flat right after switching to a new CO₂ absorber canister. What is the FIRST equipment check you should do at the circuit/patient interface?",
              answer: "Confirm the patient is connected and ventilated: check the breathing circuit connections, ETT/LMA position, and that gas is actually moving (bag movement, chest rise).",
              sourceTag: "Miller Basics 8e — Equipment — Capnography failure troubleshooting"
            },
            {
              value: 400,
              clue: "What is the key safety advantage of an oxygen failure protection device (fail-safe) in modern anesthesia machines—and what important hazard does it NOT prevent?",
              answer: "It reduces or stops other gas flow when O₂ supply pressure drops; it does NOT prevent delivery of a hypoxic mixture if oxygen and another gas are cross-connected or if flowmeters are mis-set (and it doesn’t fix pipeline O₂ contamination).",
              sourceTag: "Miller Basics 8e — Workstation — Fail-safe/oxygen protection limitations"
            },
            {
              value: 600,
              clue: "You notice a gradually rising inspired CO₂. Name TWO common causes related to the circle system and absorber.",
              answer: "Exhausted CO₂ absorbent and/or incompetent unidirectional valves (inspiratory/expiratory) causing rebreathing; also possible high dead space or incorrect assembly.",
              sourceTag: "Barash 9e — Workstation — Circle system rebreathing"
            },
            {
              value: 800,
              clue: "What is the clinical danger of using a severely desiccated CO₂ absorbent with a volatile anesthetic, and what simple prevention strategy avoids it?",
              answer: "Risk of carbon monoxide production (and potentially heat/exothermic reactions depending on absorbent/agent); prevention: avoid prolonged high fresh-gas flows through absorber when idle, replace absorbent regularly, and perform machine checks—especially after weekends.",
              sourceTag: "Barash 9e — Workstation — Absorbent desiccation / CO formation"
            },
            {
              value: 1000,
              clue: "In pressure-controlled ventilation, your delivered tidal volume suddenly falls while peak pressure is unchanged. Name TWO likely causes (one patient, one equipment) and your fastest bedside confirmation.",
              answer: "Patient: decreased compliance (e.g., pneumothorax, pulmonary edema) or increased abdominal pressure; Equipment: circuit leak/disconnection. Confirm with chest rise, auscultation, airway pressure/volume waveforms, and a quick circuit leak check + ETT cuff/position check.",
              sourceTag: "Miller Basics 8e — Workstation — PCV troubleshooting / leaks & compliance"
            }
          ]
        },
        {
          name: "Regional",
          clues: [
            {
              value: 200,
              clue: "A classic sign of intraneural injection during peripheral nerve block is what patient symptom that should make you stop immediately?",
              answer: "Severe paresthesia or pain on injection (especially with high opening injection pressure).",
              sourceTag: "Barash 9e — Regional — Nerve injury prevention"
            },
            {
              value: 400,
              clue: "Which neuraxial block is most likely to produce a dense, rapid sympathectomy: epidural or spinal—and why does that matter hemodynamically?",
              answer: "Spinal—rapid onset and dense block can cause abrupt SVR drop and venous pooling, leading to hypotension (and bradycardia in some patients).",
              sourceTag: "Miller Basics 8e — Regional — Spinal vs epidural physiology"
            },
            {
              value: 600,
              clue: "After an interscalene block, the patient develops mild dyspnea but normal oxygenation. What common physiologic effect explains this and who is at risk clinically?",
              answer: "Phrenic nerve block causing ipsilateral hemidiaphragm paresis; clinically significant in patients with limited pulmonary reserve (e.g., severe COPD, contralateral diaphragm dysfunction).",
              sourceTag: "Barash 9e — Regional — Interscalene and phrenic nerve"
            },
            {
              value: 800,
              clue: "You suspect epidural hematoma after neuraxial anesthesia. What symptom pattern should trigger emergent imaging/consult, and why is time critical?",
              answer: "New/worsening back pain with progressive motor weakness/sensory changes and/or bowel/bladder dysfunction; time critical because neurologic recovery depends on rapid decompression if hematoma is present.",
              sourceTag: "Miller Basics 8e — Regional — Neuraxial hematoma recognition"
            },
            {
              value: 1000,
              clue: "You are teaching ultrasound-guided blocks. What is the single most important probe/needle visualization concept to prevent ‘tip ambiguity’—and what’s the practical maneuver?",
              answer: "Maintain continuous visualization of the needle tip, not just the shaft; use small controlled advances with frequent re-scanning (hydrolocation/needle jiggle) and adjust beam/needle angle to keep tip in-plane.",
              sourceTag: "Barash 9e — Regional — Ultrasound needle tip safety"
            }
          ]
        }
      ],
      finalJeopardy: {
        category: "Perioperative Safety",
        clue: "An intubated patient develops sudden hypotension and rising airway pressures right after central line placement. Name the life-threatening diagnosis you must rule out immediately and the fastest bedside test in the OR/ICU.",
        answer: "Tension pneumothorax; fastest bedside test is immediate lung ultrasound (absent lung sliding/‘barcode’ sign) or rapid decompression if unstable while confirming with ultrasound/clinical findings.",
        sourceTag: "Barash 9e — Critical Care/Procedures — Pneumothorax recognition; Miller Basics 8e — Critical Events"
      }
    };

    /******************************************************************
     *  STORAGE KEYS
     ******************************************************************/
    const LS_KEY_STATE = "anesthesia_jeopardy_state_v1";
    const LS_KEY_CLUESET = "anesthesia_jeopardy_clueset_v1";

    /******************************************************************
     *  GAME STATE (scores, used clues, daily doubles, settings)
     ******************************************************************/
    const DEFAULT_STATE = {
      teams: [
        { name: "Team 1", score: 0, enabled: true },
        { name: "Team 2", score: 0, enabled: true },
        { name: "Team 3", score: 0, enabled: false }
      ],
      currentTeam: 0,
      used: {}, // key: "cIdx-qIdx" => true
      dailyDoubles: [], // array of {cIdx, qIdx}
      // Modal state
      currentClue: null, // {cIdx,qIdx}
      revealedAnswer: false,
      // Timer
      timerEnabled: false,
      timerSeconds: 45,
      timerRemaining: 45,
      timerRunning: false,
      autoAdvanceTurn: true,
      // Final Jeopardy state
      final: {
        revealedAnswer: false,
        applied: false,
        wagers: {}, // teamIdx => number
        responses: {}, // teamIdx => string
        correctness: {} // teamIdx => boolean (set when applying)
      }
    };

    /******************************************************************
     *  UTILS
     ******************************************************************/
    const $ = (sel) => document.querySelector(sel);
    const $$ = (sel) => Array.from(document.querySelectorAll(sel));
    const clamp = (n, min, max) => Math.max(min, Math.min(max, n));
    const fmtMoney = (n) => {
      const sign = n < 0 ? "-" : "";
      const abs = Math.abs(n);
      return sign + "$" + abs.toString();
    };
    const clueKey = (cIdx, qIdx) => `${cIdx}-${qIdx}`;
    const deepClone = (x) => JSON.parse(JSON.stringify(x));
    const countCluesTotal = (clueset) => clueset.categories.reduce((a,c)=>a + c.clues.length, 0);

    /******************************************************************
     *  AUDIO (Web Audio API buzzer)
     ******************************************************************/
    let audioCtx = null;
    function ensureAudio(){
      if(!audioCtx){
        audioCtx = new (window.AudioContext || window.webkitAudioContext)();
      }
    }
    function buzz(){
      try{
        ensureAudio();
        const t0 = audioCtx.currentTime;
        const osc = audioCtx.createOscillator();
        const gain = audioCtx.createGain();
        osc.type = "sawtooth";
        osc.frequency.setValueAtTime(240, t0);
        osc.frequency.exponentialRampToValueAtTime(110, t0 + 0.25);
        gain.gain.setValueAtTime(0.0001, t0);
        gain.gain.exponentialRampToValueAtTime(0.35, t0 + 0.02);
        gain.gain.exponentialRampToValueAtTime(0.0001, t0 + 0.30);
        osc.connect(gain).connect(audioCtx.destination);
        osc.start(t0);
        osc.stop(t0 + 0.32);
      } catch(e){
        // If audio fails (autoplay restrictions), silently ignore.
      }
    }

    /******************************************************************
     *  LOAD / SAVE
     ******************************************************************/
    function loadClueset(){
      const raw = localStorage.getItem(LS_KEY_CLUESET);
      if(raw){
        try{
          const parsed = JSON.parse(raw);
          if(parsed && parsed.categories && Array.isArray(parsed.categories)) return parsed;
        } catch {}
      }
      return deepClone(DEFAULT_CLUESET);
    }

    function saveClueset(clueset){
      localStorage.setItem(LS_KEY_CLUESET, JSON.stringify(clueset));
    }

    function loadState(){
      const raw = localStorage.getItem(LS_KEY_STATE);
      if(raw){
        try{
          const parsed = JSON.parse(raw);
          return { ...deepClone(DEFAULT_STATE), ...parsed };
        } catch {}
      }
      return deepClone(DEFAULT_STATE);
    }

    function saveState(){
      localStorage.setItem(LS_KEY_STATE, JSON.stringify(state));
    }

    /******************************************************************
     *  INIT: Clueset + State + Daily Doubles
     ******************************************************************/
    let clueset = loadClueset();
    let state = loadState();

    function ensureDailyDoubles(){
      // If already set and valid, keep them.
      if(Array.isArray(state.dailyDoubles) && state.dailyDoubles.length === 2){
        const ok = state.dailyDoubles.every(dd =>
          dd && Number.isInteger(dd.cIdx) && Number.isInteger(dd.qIdx) &&
          clueset.categories[dd.cIdx] && clueset.categories[dd.cIdx].clues[dd.qIdx]
        );
        if(ok && state.dailyDoubles[0].cIdx !== state.dailyDoubles[1].cIdx) return;
      }

      // Randomly assign 2 DDs not in same category, not Final.
      const cCount = clueset.categories.length;
      const picks = [];
      const usedCats = new Set();

      while(picks.length < 2){
        const cIdx = Math.floor(Math.random() * cCount);
        if(usedCats.has(cIdx)) continue;
        const qIdx = Math.floor(Math.random() * clueset.categories[cIdx].clues.length);
        picks.push({cIdx, qIdx});
        usedCats.add(cIdx);
      }
      state.dailyDoubles = picks;
    }

    function normalizeTeams(){
      // Keep exactly 3, but allow enabling 1-3.
      if(!Array.isArray(state.teams)) state.teams = deepClone(DEFAULT_STATE.teams);
      while(state.teams.length < 3) state.teams.push({ name:`Team ${state.teams.length+1}`, score:0, enabled:false });
      state.teams = state.teams.slice(0,3);
      if(state.teams.filter(t=>t.enabled).length === 0){
        state.teams[0].enabled = true;
      }
      state.currentTeam = clamp(state.currentTeam ?? 0, 0, 2);
      if(!state.teams[state.currentTeam].enabled){
        state.currentTeam = firstEnabledTeamIndex();
      }
    }

    function firstEnabledTeamIndex(){
      const idx = state.teams.findIndex(t => t.enabled);
      return idx === -1 ? 0 : idx;
    }

    normalizeTeams();
    ensureDailyDoubles();

    /******************************************************************
     *  RENDER: TEAMS
     ******************************************************************/
    function renderTeams(){
      const wrap = $("#teamsWrap");
      wrap.innerHTML = "";

      const enabledCount = state.teams.filter(t=>t.enabled).length;

      state.teams.forEach((t, i) => {
        const team = document.createElement("div");
        team.className = "team" + (i === state.currentTeam ? " active" : "");
        if(!t.enabled) team.style.opacity = 0.55;

        const row1 = document.createElement("div");
        row1.className = "teamRow";

        const nameWrap = document.createElement("div");
        nameWrap.className = "teamName";

        const badge = document.createElement("div");
        badge.className = "badge";
        badge.textContent = `T${i+1}`;

        const name = document.createElement("input");
        name.className = "nameInput";
        name.value = t.name;
        name.placeholder = `Team ${i+1}`;
        name.addEventListener("change", () => {
          state.teams[i].name = name.value.trim() || `Team ${i+1}`;
          saveState();
          updateTurnPill();
          renderTeams();
          renderFinalGrid(); // reflect new names
        });

        nameWrap.appendChild(badge);
        nameWrap.appendChild(name);

        const score = document.createElement("div");
        score.className = "score";
        score.textContent = fmtMoney(t.score);

        row1.appendChild(nameWrap);
        row1.appendChild(score);

        const row2 = document.createElement("div");
        row2.className = "teamActions";

        const toggleBtn = document.createElement("button");
        toggleBtn.className = "tiny";
        toggleBtn.textContent = t.enabled ? "Enabled" : "Disabled";
        toggleBtn.title = "Enable/disable this team (1–3 teams total)";
        toggleBtn.addEventListener("click", () => {
          const enabledNow = state.teams.filter(x=>x.enabled).length;
          if(t.enabled){
            if(enabledNow <= 1) return; // must keep at least one
            state.teams[i].enabled = false;
            if(state.currentTeam === i){
              state.currentTeam = firstEnabledTeamIndex();
            }
          } else {
            state.teams[i].enabled = true;
          }
          saveState();
          renderTeams();
          updateTurnPill();
          renderFinalGrid();
        });

        const plus = document.createElement("button");
        plus.className = "tiny ok";
        plus.textContent = "+100";
        plus.title = "Manual adjust (e.g., bonus points)";
        plus.addEventListener("click", () => {
          state.teams[i].score += 100;
          saveState();
          renderTeams();
        });

        const minus = document.createElement("button");
        minus.className = "tiny danger";
        minus.textContent = "-100";
        minus.title = "Manual adjust (e.g., penalties)";
        minus.addEventListener("click", () => {
          state.teams[i].score -= 100;
          saveState();
          renderTeams();
        });

        row2.appendChild(toggleBtn);
        row2.appendChild(plus);
        row2.appendChild(minus);

        team.appendChild(row1);
        team.appendChild(row2);

        wrap.appendChild(team);
      });

      // Adjust grid columns when < 3 enabled for nicer spacing
      if(window.innerWidth >= 620){
        wrap.style.gridTemplateColumns = `repeat(${Math.min(3, enabledCount)}, minmax(0,1fr))`;
      } else {
        wrap.style.gridTemplateColumns = `repeat(1, minmax(0,1fr))`;
      }
    }

    /******************************************************************
     *  RENDER: BOARD
     ******************************************************************/
    function isDailyDouble(cIdx, qIdx){
      return state.dailyDoubles.some(dd => dd.cIdx === cIdx && dd.qIdx === qIdx);
    }

    function renderBoard(){
      const grid = $("#boardGrid");
      grid.innerHTML = "";

      // Categories header
      clueset.categories.forEach((cat) => {
        const el = document.createElement("div");
        el.className = "cat";
        el.textContent = cat.name;
        grid.appendChild(el);
      });

      // Dollar rows: we assume each category has 5 clues, values 200..1000
      const rows = 5;
      for(let r=0;r<rows;r++){
        for(let c=0;c<clueset.categories.length;c++){
          const clue = clueset.categories[c].clues[r];
          const used = !!state.used[clueKey(c,r)];

          const tile = document.createElement("div");
          tile.className = "tile" + (used ? " used" : "") + (isDailyDouble(c,r) ? " dd" : "");
          tile.setAttribute("role","button");
          tile.setAttribute("tabindex", used ? "-1" : "0");
          tile.dataset.cIdx = c;
          tile.dataset.qIdx = r;

          const money = document.createElement("div");
          money.className = "money";
          money.textContent = "$" + clue.value;

          const pip = document.createElement("div");
          pip.className = "ddPip";
          pip.title = "Daily Double (hidden from players)";

          tile.appendChild(money);
          tile.appendChild(pip);

          const open = () => {
            if(used) return;
            openClueModal(c, r);
          };

          tile.addEventListener("click", open);
          tile.addEventListener("keydown", (e) => {
            if(e.key === "Enter" || e.key === " "){
              e.preventDefault();
              open();
            }
          });

          grid.appendChild(tile);
        }
      }

      updateCluesLeft();
    }

    function updateCluesLeft(){
      const total = countCluesTotal(clueset);
      const usedCount = Object.keys(state.used).length;
      $("#cluesLeftPill").textContent = `Clues left: ${Math.max(0, total - usedCount)}`;
    }

    function updateTurnPill(){
      const t = state.teams[state.currentTeam];
      $("#turnPill").textContent = `Turn: ${t?.name || "Team"} (T${state.currentTeam+1})`;
      $$(".team").forEach((el, idx) => {
        el.classList.toggle("active", idx === state.currentTeam);
      });
    }

    /******************************************************************
     *  TURN CONTROLS
     ******************************************************************/
    function enabledTeamIndices(){
      return state.teams.map((t,idx)=>t.enabled?idx:null).filter(x=>x!==null);
    }

    function nextEnabledTeam(curr, dir=+1){
      const enabled = enabledTeamIndices();
      if(enabled.length === 0) return 0;
      const pos = enabled.indexOf(curr);
      if(pos === -1) return enabled[0];
      const nextPos = (pos + dir + enabled.length) % enabled.length;
      return enabled[nextPos];
    }

    function nextTurn(){
      state.currentTeam = nextEnabledTeam(state.currentTeam, +1);
      saveState();
      updateTurnPill();
      renderTeams();
      renderFinalGrid();
    }

    function prevTurn(){
      state.currentTeam = nextEnabledTeam(state.currentTeam, -1);
      saveState();
      updateTurnPill();
      renderTeams();
      renderFinalGrid();
    }

    /******************************************************************
     *  TIMER
     ******************************************************************/
    let timerInterval = null;

    function fmtTime(sec){
      const m = Math.floor(sec/60);
      const s = sec%60;
      return `${String(m).padStart(2,"0")}:${String(s).padStart(2,"0")}`;
    }

    function updateTimerUI(){
      $("#timerSecondsLabel").textContent = String(state.timerSeconds);
      $("#timerPill").textContent = `Timer: ${state.timerEnabled ? "ON" : "OFF"}`;
      const cd = $("#countdown");
      cd.textContent = fmtTime(state.timerRemaining);
      cd.classList.toggle("warn", state.timerRemaining <= 10 && state.timerRemaining > 5);
      cd.classList.toggle("danger", state.timerRemaining <= 5);
    }

    function stopTimer(){
      state.timerRunning = false;
      if(timerInterval) clearInterval(timerInterval);
      timerInterval = null;
      saveState();
    }

    function startTimer(){
      if(!state.timerEnabled) return;
      ensureAudio(); // user gesture likely already occurred, but try
      stopTimer();
      state.timerRunning = true;
      saveState();
      timerInterval = setInterval(() => {
        if(!state.timerRunning) return;
        state.timerRemaining = Math.max(0, state.timerRemaining - 1);
        updateTimerUI();
        saveState();
        if(state.timerRemaining === 0){
          stopTimer();
          buzz();
        }
      }, 1000);
    }

    function resetTimer(toFull=true){
      stopTimer();
      state.timerRemaining = toFull ? state.timerSeconds : state.timerRemaining;
      updateTimerUI();
      saveState();
    }

    /******************************************************************
     *  CLUE MODAL LOGIC
     ******************************************************************/
    const modalBackdrop = $("#modalBackdrop");
    const clueTextEl = $("#clueText");
    const answerEl = $("#answerText");
    const showAnswerBtn = $("#showAnswerBtn");
    const correctBtn = $("#correctBtn");
    const incorrectBtn = $("#incorrectBtn");
    const answerStatePill = $("#answerStatePill");
    const modalDD = $("#modalDD");
    const wagerBox = $("#wagerBox");
    const wagerInput = $("#wagerInput");
    const wagerHint = $("#wagerHint");
    const modalStatus = $("#modalStatus");

    function openModal(){
      modalBackdrop.classList.add("show");
      modalBackdrop.setAttribute("aria-hidden","false");
      document.body.style.overflow = "hidden";
    }
    function closeModal(){
      modalBackdrop.classList.remove("show");
      modalBackdrop.setAttribute("aria-hidden","true");
      document.body.style.overflow = "";
      // Stop timer when closing clue (optional; keep it stopped)
      stopTimer();
      resetTimer(true);
      state.currentClue = null;
      state.revealedAnswer = false;
      saveState();
    }

    function currentTeam(){
      return state.teams[state.currentTeam];
    }

    function computeDailyDoubleMaxWager(baseValue){
      // Jeopardy convention: may wager up to current score, or the highest clue value on the board (here 1000), whichever is larger.
      const score = currentTeam().score;
      return Math.max(1000, score);
    }

    function openClueModal(cIdx, qIdx){
      const cat = clueset.categories[cIdx];
      const clue = cat.clues[qIdx];
      const dd = isDailyDouble(cIdx, qIdx);

      state.currentClue = {cIdx, qIdx};
      state.revealedAnswer = false;
      saveState();

      $("#modalCat").textContent = cat.name;
      $("#modalVal").textContent = "$" + clue.value;
      $("#modalHeading").textContent = dd ? "Daily Double!" : "Clue";
      clueTextEl.textContent = clue.clue;
      answerEl.textContent = clue.answer;
      answerEl.classList.remove("show");
      answerStatePill.textContent = "Answer: hidden";

      modalDD.style.display = dd ? "inline-flex" : "none";
      correctBtn.disabled = true;
      incorrectBtn.disabled = true;

      // Show DD wager UI if needed
      if(dd){
        wagerBox.classList.add("show");
        const max = computeDailyDoubleMaxWager(clue.value);
        wagerInput.value = String(Math.min(clue.value, max));
        wagerInput.min = "0";
        wagerInput.max = String(max);
        wagerHint.textContent = `Max wager: ${fmtMoney(max)} (Jeopardy-style: max of $1000 or your current score). This wager will be used when scoring Correct/Incorrect.`;
      } else {
        wagerBox.classList.remove("show");
      }

      modalStatus.innerHTML = `<span class="pill">Turn: ${currentTeam().name}</span> <span class="pill">Hidden source tag stored</span>`;

      openModal();

      // Start timer automatically when clue opens
      if(state.timerEnabled){
        state.timerRemaining = state.timerSeconds;
        updateTimerUI();
        startTimer();
      }
    }

    function revealAnswer(){
      if(!state.currentClue) return;
      state.revealedAnswer = true;
      answerEl.classList.add("show");
      answerStatePill.textContent = "Answer: shown";
      correctBtn.disabled = false;
      incorrectBtn.disabled = false;
      saveState();
    }

    function scoreClue(isCorrect){
      const sel = state.currentClue;
      if(!sel) return;

      const {cIdx, qIdx} = sel;
      const clue = clueset.categories[cIdx].clues[qIdx];
      const dd = isDailyDouble(cIdx, qIdx);

      let delta = clue.value;
      if(dd){
        const max = computeDailyDoubleMaxWager(clue.value);
        const wager = clamp(parseInt(wagerInput.value || "0", 10) || 0, 0, max);
        delta = wager;
      }

      if(!isCorrect) delta = -delta;

      state.teams[state.currentTeam].score += delta;
      state.used[clueKey(cIdx,qIdx)] = true;

      // Close and advance
      saveState();
      renderTeams();
      renderBoard();
      updateTurnPill();
      updateCluesLeft();

      closeModal();

      if(state.autoAdvanceTurn){
        nextTurn();
      }
    }

    /******************************************************************
     *  FINAL JEOPARDY
     ******************************************************************/
    const finalBackdrop = $("#finalBackdrop");
    const finalClueText = $("#finalClueText");
    const finalAnswerText = $("#finalAnswerText");
    const finalShowAnswerBtn = $("#finalShowAnswerBtn");
    const finalApplyBtn = $("#finalApplyBtn");
    const finalAnswerState = $("#finalAnswerState");
    const finalGridEl = $("#finalGrid");
    const finalStatus = $("#finalStatus");
    const finalCatPill = $("#finalCatPill");
    const finalHint = $("#finalHint");

    function openFinal(){
      const fj = clueset.finalJeopardy;
      finalCatPill.textContent = fj.category;

      finalClueText.textContent = fj.clue;
      finalHint.textContent = "Enter each team’s wager and response. When ready, reveal the answer, then mark each response correct/incorrect by checkbox and apply results.";

      finalAnswerText.textContent = fj.answer;
      finalAnswerText.classList.remove("show");
      finalAnswerState.textContent = "Answer: hidden";
      finalApplyBtn.disabled = true;

      renderFinalGrid();
      finalStatus.innerHTML = `<span class="pill">Final category: ${fj.category}</span> <span class="pill">Hidden source tag stored</span>`;

      finalBackdrop.classList.add("show");
      finalBackdrop.setAttribute("aria-hidden","false");
      document.body.style.overflow = "hidden";
    }

    function closeFinal(){
      finalBackdrop.classList.remove("show");
      finalBackdrop.setAttribute("aria-hidden","true");
      document.body.style.overflow = "";
      saveState();
    }

    function renderFinalGrid(){
      if(!finalGridEl) return;
      finalGridEl.innerHTML = "";

      const enabled = enabledTeamIndices();
      enabled.forEach((idx) => {
        const t = state.teams[idx];
        const box = document.createElement("div");
        box.className = "finalTeamBox";

        const top = document.createElement("div");
        top.className = "finalTeamTop";
        top.innerHTML = `<div class="nm">${t.name}</div><div class="sc">Current: ${fmtMoney(t.score)}</div>`;

        const inputs = document.createElement("div");
        inputs.className = "finalInputs";

        const resp = document.createElement("input");
        resp.type = "text";
        resp.placeholder = "Team response (free text)";
        resp.value = state.final.responses[idx] || "";
        resp.addEventListener("input", () => {
          state.final.responses[idx] = resp.value;
          saveState();
        });

        const wager = document.createElement("input");
        wager.type = "number";
        wager.min = "0";
        wager.step = "50";
        wager.placeholder = "Wager";
        wager.value = (state.final.wagers[idx] ?? "").toString();
        wager.addEventListener("input", () => {
          const v = parseInt(wager.value || "0", 10);
          state.final.wagers[idx] = clamp(isNaN(v)?0:v, 0, Math.max(0, t.score));
          saveState();
        });

        const checkWrap = document.createElement("label");
        checkWrap.style.display = "flex";
        checkWrap.style.alignItems = "center";
        checkWrap.style.gap = "8px";
        checkWrap.style.flexWrap = "wrap";
        checkWrap.style.fontWeight = "900";
        checkWrap.style.color = "rgba(233,246,255,.95)";
        const cb = document.createElement("input");
        cb.type = "checkbox";
        cb.checked = !!state.final.correctness[idx];
        cb.disabled = !state.final.revealedAnswer;
        cb.addEventListener("change", () => {
          state.final.correctness[idx] = cb.checked;
          saveState();
        });
        const cbText = document.createElement("span");
        cbText.textContent = "Correct?";
        checkWrap.appendChild(cb);
        checkWrap.appendChild(cbText);

        inputs.appendChild(resp);
        inputs.appendChild(wager);
        inputs.appendChild(checkWrap);

        const hint = document.createElement("div");
        hint.className = "hint";
        hint.textContent = `Max wager: ${fmtMoney(Math.max(0, t.score))} (cannot exceed current score).`;

        box.appendChild(top);
        box.appendChild(inputs);
        box.appendChild(hint);
        finalGridEl.appendChild(box);
      });
    }

    function revealFinalAnswer(){
      state.final.revealedAnswer = true;
      finalAnswerText.classList.add("show");
      finalAnswerState.textContent = "Answer: shown";
      finalApplyBtn.disabled = false;

      // Enable checkboxes
      $$("#finalGrid input[type='checkbox']").forEach(cb => cb.disabled = false);

      saveState();
    }

    function applyFinal(){
      if(state.final.applied){
        alert("Final Jeopardy has already been applied for this game state.");
        return;
      }
      const enabled = enabledTeamIndices();

      enabled.forEach((idx) => {
        const t = state.teams[idx];
        const wager = clamp(parseInt(state.final.wagers[idx] ?? 0, 10) || 0, 0, Math.max(0, t.score));
        const correct = !!state.final.correctness[idx];
        t.score += (correct ? wager : -wager);
      });

      state.final.applied = true;
      saveState();
      renderTeams();
      updateTurnPill();
      alert("Final Jeopardy applied to scores.");
    }

    /******************************************************************
     *  EXPORT / IMPORT CLUES
     ******************************************************************/
    function downloadJSON(filename, obj){
      const blob = new Blob([JSON.stringify(obj, null, 2)], {type:"application/json"});
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = filename;
      document.body.appendChild(a);
      a.click();
      a.remove();
      URL.revokeObjectURL(url);
    }

    function exportClues(){
      downloadJSON("anesthesia-jeopardy-clues.json", clueset);
    }

    function validateClueset(obj){
      if(!obj || typeof obj !== "object") return "Not an object.";
      if(!Array.isArray(obj.categories) || obj.categories.length !== 6) return "Expected exactly 6 categories.";
      const names = obj.categories.map(c => c.name);
      const required = ["Airway","Critical Care","OB","Cardiothoracic","Anesthesia Workstation","Regional"];
      for(const r of required){
        if(!names.includes(r)) return `Missing required category name: ${r}`;
      }
      for(const cat of obj.categories){
        if(!Array.isArray(cat.clues) || cat.clues.length !== 5) return `Category "${cat.name}" must have exactly 5 clues.`;
        for(const cl of cat.clues){
          if(![200,400,600,800,1000].includes(cl.value)) return `Clue values must be 200/400/600/800/1000 (found ${cl.value}).`;
          for(const k of ["clue","answer","sourceTag"]){
            if(typeof cl[k] !== "string" || !cl[k].trim()) return `Each clue must include non-empty "${k}".`;
          }
        }
      }
      if(!obj.finalJeopardy || typeof obj.finalJeopardy !== "object") return "Missing finalJeopardy.";
      for(const k of ["category","clue","answer","sourceTag"]){
        if(typeof obj.finalJeopardy[k] !== "string" || !obj.finalJeopardy[k].trim()) return `finalJeopardy must include non-empty "${k}".`;
      }
      return null;
    }

    function importCluesFromFile(file){
      const reader = new FileReader();
      reader.onload = () => {
        try{
          const obj = JSON.parse(reader.result);
          const err = validateClueset(obj);
          if(err){
            alert("Invalid clue set JSON: " + err);
            return;
          }
          clueset = obj;
          saveClueset(clueset);

          // Reset used clues + re-roll daily doubles to fit new set
          state.used = {};
          state.dailyDoubles = [];
          ensureDailyDoubles();

          // Reset Final Jeopardy tracking (but keep scores)
          state.final = deepClone(DEFAULT_STATE.final);

          saveState();
          renderBoard();
          updateCluesLeft();
          alert("Clue set imported successfully. Board has been refreshed and Daily Doubles re-assigned.");
        } catch(e){
          alert("Could not parse JSON file.");
        }
      };
      reader.readAsText(file);
    }

    /******************************************************************
     *  RESET GAME
     ******************************************************************/
    function resetGame(){
      if(!confirm("Reset game? This clears used clues, Daily Doubles, and scores (but keeps the current clue set).")) return;

      const keepTeams = deepClone(state.teams).map(t => ({...t, score:0}));
      state = deepClone(DEFAULT_STATE);
      state.teams = keepTeams;
      normalizeTeams();
      ensureDailyDoubles();
      saveState();

      renderTeams();
      renderBoard();
      updateTurnPill();
      updateTimerUI();
      updateCluesLeft();

      alert("Game reset.");
    }

    /******************************************************************
     *  EVENT WIRING
     ******************************************************************/
    showAnswerBtn.addEventListener("click", revealAnswer);
    correctBtn.addEventListener("click", () => scoreClue(true));
    incorrectBtn.addEventListener("click", () => scoreClue(false));
    $("#closeBtn").addEventListener("click", closeModal);
    $("#modalCloseTop").addEventListener("click", closeModal);
    modalBackdrop.addEventListener("click", (e) => {
      if(e.target === modalBackdrop) closeModal();
    });

    $("#finalBtn").addEventListener("click", openFinal);
    $("#finalCloseBtn").addEventListener("click", closeFinal);
    $("#finalCloseTop").addEventListener("click", closeFinal);
    finalBackdrop.addEventListener("click", (e) => {
      if(e.target === finalBackdrop) closeFinal();
    });

    finalShowAnswerBtn.addEventListener("click", () => {
      revealFinalAnswer();
      renderFinalGrid();
    });
    finalApplyBtn.addEventListener("click", applyFinal);

    $("#exportBtn").addEventListener("click", exportClues);
    $("#importBtn").addEventListener("click", () => $("#importFile").click());
    $("#importFile").addEventListener("change", (e) => {
      const file = e.target.files && e.target.files[0];
      if(file) importCluesFromFile(file);
      e.target.value = "";
    });

    $("#resetBtn").addEventListener("click", resetGame);

    $("#nextTurnBtn").addEventListener("click", nextTurn);
    $("#prevTurnBtn").addEventListener("click", prevTurn);

    $("#autoTurnBtn").addEventListener("click", () => {
      state.autoAdvanceTurn = !state.autoAdvanceTurn;
      $("#autoTurnState").textContent = state.autoAdvanceTurn ? "ON" : "OFF";
      saveState();
    });

    $("#timerEnabled").addEventListener("change", (e) => {
      state.timerEnabled = !!e.target.checked;
      $("#timerPill").textContent = `Timer: ${state.timerEnabled ? "ON" : "OFF"}`;
      saveState();
      updateTimerUI();
    });

    $("#timerSeconds").addEventListener("input", (e) => {
      state.timerSeconds = parseInt(e.target.value, 10);
      state.timerRemaining = state.timerSeconds;
      saveState();
      updateTimerUI();
    });

    $("#timerStart").addEventListener("click", () => {
      // User gesture unlocks audio in many browsers
      startTimer();
    });
    $("#timerStop").addEventListener("click", stopTimer);
    $("#timerReset").addEventListener("click", () => resetTimer(true));
    $("#buzzBtn").addEventListener("click", buzz);

    // Global key handling
    document.addEventListener("keydown", (e) => {
      if(e.key === "Escape"){
        if(finalBackdrop.classList.contains("show")) closeFinal();
        if(modalBackdrop.classList.contains("show")) closeModal();
      }
      // Spacebar to show answer when modal open (nice for projector use)
      if(e.key === " " && modalBackdrop.classList.contains("show")){
        e.preventDefault();
        if(!state.revealedAnswer) revealAnswer();
      }
    });

    /******************************************************************
     *  BOOTSTRAP UI FROM STATE
     ******************************************************************/
    function hydrateFromState(){
      $("#timerEnabled").checked = !!state.timerEnabled;
      $("#timerSeconds").value = String(state.timerSeconds);
      $("#timerSecondsLabel").textContent = String(state.timerSeconds);
      $("#autoTurnState").textContent = state.autoAdvanceTurn ? "ON" : "OFF";
      updateTimerUI();
      renderTeams();
      renderBoard();
      updateTurnPill();
      updateCluesLeft();
    }

    // Make sure timer remaining is valid
    state.timerSeconds = clamp(state.timerSeconds || 45, 30, 60);
    state.timerRemaining = clamp(state.timerRemaining || state.timerSeconds, 0, state.timerSeconds);

    // Save any normalization back
    saveClueset(clueset);
    saveState();
    hydrateFromState();

    /******************************************************************
     *  DEV NOTE (Hidden): Access source tags in console
     ******************************************************************/
    window.__AJ = {
      getClueset: () => deepClone(clueset),
      getState: () => deepClone(state),
      getSourceTag: (cIdx,qIdx) => clueset.categories[cIdx].clues[qIdx].sourceTag,
      getFinalSourceTag: () => clueset.finalJeopardy.sourceTag
    };
  </script>
</body>
</html>
